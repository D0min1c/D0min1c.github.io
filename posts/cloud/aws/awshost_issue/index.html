<!doctype html><html><head><title>서버가 갑자기 박살나셨습니다. -AWS</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="ie=edge"><link rel=stylesheet href=/css/bootstrap.min.css><link rel=stylesheet href=/css/layouts/main.css><link rel=stylesheet href=/css/navigators/navbar.css><link rel=stylesheet href=/css/plyr.css><link rel=stylesheet href=/css/flag-icon.min.css><link href="https://fonts.googleapis.com/css2?family=Muli:wght@300;400;500;600" rel=stylesheet><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.min.css><link rel=icon type=image/png href=/images/site/favicon_hu1d79931af21da1953430965fd067c561_13812_42x0_resize_q75_box.JPG><meta property="og:title" content="서버가 갑자기 박살나셨습니다. -AWS"><meta property="og:description" content="Sample post with multiple images, embedded video ect."><meta property="og:type" content="article"><meta property="og:url" content="https://hugo-toha.github.io/posts/cloud/aws/awshost_issue/"><meta property="article:published_time" content="2021-06-22T00:00:00+00:00"><meta property="article:modified_time" content="2021-06-22T00:00:00+00:00"><meta name=description content="Sample post with multiple images, embedded video ect."><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/styles/atom-one-dark.min.css><link rel=stylesheet href=/css/layouts/single.css><link rel=stylesheet href=/css/navigators/sidebar.css><link rel=stylesheet href=/css/style.css><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-199142344-2','auto');ga('send','pageview');}</script></head><body data-spy=scroll data-target=#TableOfContents data-offset=80><div class="container-fluid bg-dimmed wrapper"><nav class="navbar navbar-expand-xl top-navbar final-navbar shadow"><div class=container><button class="navbar-toggler navbar-light" id=sidebar-toggler type=button onclick=toggleSidebar()>
<span class=navbar-toggler-icon></span></button>
<a class=navbar-brand href=/><img src=/images/site/main-logo_hu1d79931af21da1953430965fd067c561_13812_42x0_resize_q75_box.JPG alt=Logo>
255.255.248.0</a>
<button class="navbar-toggler navbar-light" id=toc-toggler type=button onclick=toggleTOC()>
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse lang-selector" id=top-nav-items><ul class="navbar-nav ml-auto"></ul></div></div><img src=/images/site/main-logo_hu1d79931af21da1953430965fd067c561_13812_42x0_resize_q75_box.JPG class=d-none id=main-logo alt=Logo>
<img src=/images/site/inverted-logo_hu1d79931af21da1953430965fd067c561_13812_42x0_resize_q75_box.JPG class=d-none id=inverted-logo alt="Inverted Logo"></nav><section class=sidebar-section id=sidebar-section><div class=sidebar-holder><div class=sidebar id=sidebar><form class=mx-auto method=get action=/search><input type=text name=keyword placeholder=Search data-search id=search-box></form><div class=sidebar-tree><ul class=tree id=tree><li id=list-heading><a href=/posts data-filter=all>Posts</a></li><div class=subtree><li><a href=/posts/about_dominic/ title=😎About_dominic😎>😎About_dominic😎</a></li><li><i class="fas fa-minus-circle"></i><a class=active href=/posts/cloud/>Cloud</a><ul class=active><li><i class="fas fa-minus-circle"></i><a class=active href=/posts/cloud/aws/>AWS</a><ul class=active><li><a class=active href=/posts/cloud/aws/awshost_issue/ title="AWS 이슈 (갑.서.박)">AWS 이슈 (갑.서.박)</a></li><li><a href=/posts/cloud/aws/awsgeneration/ title="세대를 교체중입니다. -AWS">세대를 교체중입니다. -AWS</a></li></ul></li><li><i class="fas fa-plus-circle"></i><a href=/posts/cloud/gcp/>GCP</a><ul><li><a href=/posts/cloud/gcp/gcpissue-1/ title="GCP 이슈 (갑.서.박)">GCP 이슈 (갑.서.박)</a></li><li><a href=/posts/cloud/gcp/gcpnetwork-1/ title="GCP-VPC 기초 1편">GCP-VPC 기초 1편</a></li><li><a href=/posts/cloud/gcp/gcpnetwork-2/ title="GCP-VPC 기초 2편">GCP-VPC 기초 2편</a></li><li><a href=/posts/cloud/gcp/k8sgke-pod/ title=k8s(GKE-Pod)>k8s(GKE-Pod)</a></li><li><a href=/posts/cloud/gcp/k8sgke-service/ title=k8s(GKE-Service)>k8s(GKE-Service)</a></li><li><a href=/posts/cloud/gcp/k8sgke-volume/ title=k8s(GKE-volume)>k8s(GKE-volume)</a></li></ul></li></ul></li><li><i class="fas fa-plus-circle"></i><a href=/posts/kubernetes/>Kubernetes</a><ul><li><a href=/posts/kubernetes/k8snetworking/ title=k8s(Networking)>k8s(Networking)</a></li><li><a href=/posts/kubernetes/k8scomponent/ title=k8s(component)>k8s(component)</a></li><li><a href=/posts/kubernetes/k8singress/ title=k8s(Ingress)>k8s(Ingress)</a></li><li><a href=/posts/kubernetes/k8svolume/ title=k8s(Volume)>k8s(Volume)</a></li></ul></li><li><i class="fas fa-plus-circle"></i><a href=/posts/certification/>Certification</a><ul><li><i class="fas fa-plus-circle"></i><a href=/posts/certification/cka/>CKA</a><ul><li><a href=/posts/certification/cka/etcd/ title="etcd backup&restore">etcd backup&restore</a></li><li><a href=/posts/certification/cka/pod/ title="Pod hands-on">Pod hands-on</a></li></ul></li></ul></li></div></ul></div></div></div></section><section class=content-section id=content-section><div class=content><div class="container p-0 read-area"><div class="hero-area col-sm-12" id=hero-area style=background-image:url(https://hugo-toha.github.io/posts/cloud/aws/awshost_issue/images/host_thumnail.jpg)></div><div class=page-content><div class="author-profile ml-auto align-self-lg-center"><img class=rounded-circle src=/images/author/dominic_hue8656283646074d0d4d459b13fee860e_56605_120x120_fit_box_2.png alt="Author Image"><h5 class=author-name>dominic</h5><p>June 22, 2021</p></div><div class=title><h1>서버가 갑자기 박살나셨습니다. -AWS</h1></div><div class=post-content id=post-content><p>AWS EC2 Maintenance에 대해 적어뒀습니다.</p><h2 id=배경>배경</h2><p>GCP 혹은 AWS를 사용하면 심심치않게 일어나는 서비스이슈, 1년에 한 두번 일어날까말까하는 리전이슈가 있습니다.
서비스마다 대응방법이 다르지만, 우선 가장 비번하게 일어나는 Host hardware 이슈에 대해 기록합니다.</p><p>종종 Host Error! 혹은 Instance check Failed를 경험한 적이 있으시죠?
우선 AWS에서의 이슈에 대해 정리해보았습니다.</p><h3 id=aws-system-check-failed>AWS System Check failed</h3><p>다들 아시다시피 ec2 인스턴스는 <strong>AWS에서 Iaas 방식으로 제공하는 서비스</strong>이기에 사용자가 해당 ec2 인스턴스를 프로비저닝하게 될 경우 선택한 리전과 가용영역의 데이터 센터 내 host computer에서 hypervisor 위에 고객의 요청에 의해 insatnce를 생성하여 제공하는 방식입니다.</p><p>여기서 만약 hypervisor와 instance간의 Network이 끊긴다면..? 아니면 Host 장비에 불이 난다면&mldr;?</p><p><strong>와장창-!</strong> 말 그대로 인스턴스가 와장창 납니다.</p><p>이러한 갑작스러운 이슈로 인해 발생하는 AWS 하드웨어의 Maintenance Event 혹은 System checkfailed 이슈로 인해 발생하는 예기치않은 이슈에 대해 정리하고 사례에 맞춰 사용자들은 어떻게 대처해야하는지에 경험을 공유하고자 합니다.</p><p>들어가기 앞서 모든 AWS Maintenance 는 일정을 조정하는 것이 가능하다는 점 참고해주시면 되겠습니다.</p><h2 id=aws-maintenance>AWS Maintenance</h2><p>우선 AWS에서의 EC2 Event 종류와 Cloudwatch에서 확인할 수 있는 Status Check failed 지표는 아래와 같은 내용을 포함합니다.</p><ul><li><p>AWS Event</p><ul><li>Instance stop : 예약된 시간에 인스턴스가 중지됩니다. 인스턴스를 다시 시작하면 <strong>새 호스트로 마이그레이션됩니다.</strong></li></ul><p>이러한 유형은 Amazon EBS가 지원하는 인스턴스에만 적용됩니다.</p><ul><li>Instance retirement</li><li>Instance reboot</li><li>System reboot</li><li>System maintenance</li></ul></li></ul><h3 id=instance-stop>Instance stop</h3><p>: 예약된 시간에 인스턴스가 중지됩니다. 인스턴스를 다시 시작하면 <strong>새 호스트로 마이그레이션됩니다.</strong></p><p>Instance stop이 일어나는 경우는 대게 Host hardware의 폐기 날이 결정된 것입니다.</p><p>이 경우, Maintenance 일정 이전에 스스로 stop/start를 진행하여 해소 할 수 있습니다.</p><p>두 눈을 크게 뜨고 정확히 봐야합니다. Instance reboot이 아닌, Stop인 것을요.</p><p>Stop되어있는 인스턴스는 어떤 트리거가 발생하기 전까지는 결코 혼자서 벌떡 일어나진 않습니다.</p><pre><code>이러한 유형은 Amazon EBS가 지원하는 인스턴스에만 적용됩니다.
</code></pre><p>참고로 PHD(persnal Health Dashborad)에서 성능저하로 인해 예약된 이벤트들의 경우 되도록 빨리 인스턴스를 재부팅하여 새 호스트로 마이그레이션하는 것이 좋습니다.</p><p>이미 성능이 저하된 호스트 하드웨어이기에 언제 어떤이슈가 발생할지 모르는 폭탄이기 때문입니다.</p><h3 id=instance-retirement>Instance retirement</h3><p>: 예약된 시간에 인스턴스가 Amazon EBS에서 지원되는 경우 중지되거나 인스턴스 스토어에서 지원되는 경우 종료됩니다.</p><p>말 그대로 EBS 지원 인스턴스는 stop, 인스턴스스토어 지원 인스턴스는 terminate되는 이벤트입니다.</p><p>아직 발생해본적이 없어서 패스하겠습니다. (뭐..다를거 있겠냐만..)</p><h3 id=system-maintenance>System maintenance</h3><p>: 예약된 시간에 네트워크 또는 전력 유지 관리로 인스턴스가 일시적인 영향을 받을 수 있습니다</p><p>네트워크 유지 관리 시에는 예약된 인스턴스의 네트워크 연결이 잠시 동안 끊어집니다. 유지 관리가 완료되면 인스턴스의 네트워크 연결이 평소처럼 복구됩니다.</p><p>전력 유지 관리 시에는 예약된 인스턴스가 잠시 동안 오프라인 상태로 전환되었다가 재부팅됩니다. 재부팅 이후에도 인스턴스의 모든 구성 설정은 그대로 유지됩니다.</p><p>이제 가장 주로 겪은 두가지 이벤트를 다뤄보겠습니다.</p><p>하이라이트 입니다.</p><h3 id=instance-reboot>Instance reboot</h3><p>: 예약된 시간에 인스턴스가 재부팅됩니다.</p><p>말그대로 인스턴스의 재부팅을 의미하기에 os에서 reboot하는것과 동일하게 동작합니다.</p><p>메인터넌스 일정 이내에 사용자가 스스로 reboot을 먼저 실행하여 해소하는 방법과 메인터넌스 일정에 자연스럽게 해소하는 방법이 있습니다. EBS 볼륨의 데이터는 영향을 받지 않습니다.</p><p>유의사항으로는 인스턴스 재부팅 시 인스턴스스토어 볼륨 데이터와 public IP가 변경되기에 Elastic IP를 할당하여 고정 IP를 사용하고</p><p>만약 인스턴스스토어 볼륨을 사용한다면 미리 데이터를 백업해놓아야 합니다.</p><h3 id=system-reboot>System reboot</h3><p>: 예약된 시간에 인스턴스의 호스트가 재부팅됩니다.</p><p>인스턴스의 재부팅이 아닌, 인스턴스가 올라가있는 호스트 하드웨어의 재부팅입니다.</p><p>일반적인 사용자가 스스로 이벤트를 해소할 수 있는 방법이 없습니다.</p><p><del>(일반적이지 못한 경우 : 인스턴스 위치를 어떻게든 찾아서 업체점검으로 속이고 치..침투하여 리붓)</del></p><p>농담이고, AMI를 생성해서 다시 만들면 메인터넌스를 회피할 수 있습니다. (Instance reboot과 동일하게 Elastic IP 유지필요, 인스턴스스토어 볼륨 데이터 증발)</p><p>필요에 의하지 않다면 AWS에 온전히 작업을 맡기는 것이 좋을 것 같습니다.</p><p>다행히도 AWS가 시스템을 재부팅해도 DNS 이름이나 IP 주소와 같은 구성이 변경되지 않으며, 로컬 인스턴스 스토어에 저장된 데이터도 그대로 보존됩니다.</p><p>통상 이러한 재부팅들은 수 분 내에 끝난다고 말하지만 대부분의 경우 3분안에 이벤트가 종료되었던 것으로 경험했습니다.</p><p>모든 경우에서 서비스 서버(EC2)들은 AMI나 Snapshot을 통해 백업해두는 것이 가장 현명합니다.</p><p>이제 메인 빌런인 <strong>갑작스러운 하드웨어 이슈에 의한 EC2 Reboot</strong> 입니다.</p><p>보통 잘자다가 새벽에 천둥같은 알람이 울면 인스턴스의 모니터링 지표에 (System, Instance) Status check failed 알람이 발생하는 경우도 있습니다.</p><p>이게 무엇인고하니, AWS는 두 가지 상태 확인을 통해 각 EC2 인스턴스 상태를 내부 모니터링 툴을 사용하여 모니터링합니다.</p><p>자세한 내용은 AWS Docs에 잘나와있으니 축약하여 메모해놓겠습니다.</p><ul><li>요약<ul><li>시스템 상태 확인 실패(System status check failed)는 인스턴스가 실행되는 AWS 시스템에 문제가 있음을 나타냅니다. (하드웨어 이슈)</li><li>인스턴스 상태 확인 실패(Instance status check failed)는 대게 OOM(OutOfMemory) 등 리소스 이슈 혹은 잘못된 OS config 수정에 의해 발생합니다. (OS 이슈) ~~(간혹 커널이슈)</li></ul></li></ul><p>그렇기에 만약 인스턴스가 죽어서 Cloudwatch의 메트릭에서 위와같은 상태 검사 메트릭을 우선 확인한 뒤,</p><p>CPU, memory (Custom Metric으로 받아와야합니다.), Volume IO 등 리소스 사용량과 콘솔 상에서 확인할 수 있는 시스템 로그를 통해 dmsg 로그 확인 및 본인이 마지막으로 서버에 무슨 작업을 했는지 확인해야하고 (어쩔때는 갑자기 DHCP서버에서 EC2가 IP를 못받아서 죽었던 경험도 있습니다. Network Manager issue 였죠..)</p><p>시스템 상태검사 실패라면 재빠르게 stop/start 혹은 해당 이벤트를 트리거로 걸어두어 자동 reboot 작업을 걸어두는 것이 좋습니다.</p><p><a href=https://docs.aws.amazon.com/ko_kr/AWSEC2/latest/WindowsGuide/monitoring-instances-status-check.html>AWS 인스턴스 상태 모니터링 링크</a></p><p>여러분 세상에 100% 안죽는 서버는 없습니다. <del>(사장님 저는 안죽습니다)</del></p><p>그러니 너무 스트레스 받아하지 마세요. 어쩔 수 없는걸요.</p><p>서버 한 두대가 죽어도 서비스는 유지될 수 있도록 고가용성 구조를 구성하시는게 가장 좋습니다.
여기까지가 AWS나 파트너사의 입장이고 실제 운영하는 입장에선 모든 상황에 고가용성 구성이 성능적이나, 비용적으로 효율적이지 못한 구조일 수 있습니다.</p><p>그러하니 항상 두 가지만 생각하시면 됩니다.</p><ol><li><p>서버는 갑작스럽게 죽을 수 있다. -> 고가용성 구조가 필요하다 -> 비용적으로 이슈가 있다 -> 모니터링 시스템이 의존도가 높을 수 밖에 없다.
(가령 EC2 host issue alret 발생 시, EC2 auto reboot trigger 등)</p></li><li><p>AMI 백업을 주기적으로 실행한다.</p></li></ol><p>이미 서버가 죽어서 서비스에 이슈가 발생했을 경우에 가장 필요한건 서비스의 빠른 Recovery이니까요.</p><p>관련해서 나중에 모니터링관련(Promethus, logstash,Fluentd) 내용도 정리하도록 하겠습니다.</p></div><hr><div class="row next-prev-navigator"></div><hr></div></div></div><a id=scroll-to-top class=btn><i class="fas fa-chevron-circle-up"></i></a></section><section class=toc-section id=toc-section><div class=toc-holder><h5 class="text-center pl-3">Table of Contents</h5><hr><div class=toc><nav id=TableOfContents><ul><li><a href=#배경>배경</a><ul><li><a href=#aws-system-check-failed>AWS System Check failed</a></li></ul></li><li><a href=#aws-maintenance>AWS Maintenance</a><ul><li><a href=#instance-stop>Instance stop</a></li><li><a href=#instance-retirement>Instance retirement</a></li><li><a href=#system-maintenance>System maintenance</a></li><li><a href=#instance-reboot>Instance reboot</a></li><li><a href=#system-reboot>System reboot</a></li></ul></li></ul></nav></div></div></section></div><footer class="container-fluid text-center align-content-center footer pb-2"><div class="container pt-5"><div class="row text-left"><div class="col-md-4 col-sm-12"><h5>Navigation</h5><ul><li class=nav-item><a class=smooth-scroll href=/#about>About</a></li><li class=nav-item><a class=smooth-scroll href=/#skills>Skills</a></li><li class=nav-item><a class=smooth-scroll href=/#experiences>Experiences</a></li><li class=nav-item><a class=smooth-scroll href=/#projects>Projects</a></li><li class=nav-item><a class=smooth-scroll href=/#recent-posts>Recent Posts</a></li></ul></div></div></div><hr><div class=container><div class="row text-left"><div class=col-md-4><a id=theme href=https://github.com/hossainemruz/toha target=_blank rel=noopener><img src=/images/theme-logo_hu8376fd15465fef26ffe66b6bcf0ca686_13669_32x0_resize_box_2.png alt="Toha Theme Logo">
Toha</a></div><div class="col-md-4 text-center">© 2020 Copyright.</div><div class="col-md-4 text-right"><a id=hugo href=https://gohugo.io/ target=_blank rel=noopener>Powered by
<img src=/images/hugo-logo.svg alt="Hugo Logo" height=18></a></div></div></div></footer><script type=text/javascript src=/js/jquery-3.4.1.min.js></script><script type=text/javascript src=/js/popper.min.js></script><script type=text/javascript src=/js/bootstrap.min.js></script><script type=text/javascript src=/js/navbar.js></script><script type=text/javascript src=/js/plyr.js></script><script type=text/javascript src=/js/main.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/highlight.min.js></script><script src=/js/single.js></script><script>hljs.initHighlightingOnLoad();</script></body></html>