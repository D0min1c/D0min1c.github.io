---
title: 아니 글쎄 갑자기 인스턴스가 죽었다니까요? - AWS
categories:
  - "cloud"
tags:
  - "aws"
  - "public cloud"
---
AWS/GCP에서 일어나는 VM이 갑자기 뻗거나 리부팅되는 이유에 대해...

마른하늘의 날벼락 같은 인스턴스 Reboot 현상에 대해 원인과 경험을 적어놨습니다. 

<!--more-->

## 배경
GCP 혹은 AWS를 사용하면서 종종 Host Error! 혹은 Instance check Failed를 경험한 적이 있으시죠?
우선 AWS를 기준으로 이슈에 대해 정리해보았습니다.

### AWS System Check failed
 다들 아시다시피 ec2 인스턴스는 **AWS에서 Iaas 방식으로 제공하는 서비스**이기에 사용자가 해당 ec2 인스턴스를 프로비저닝하게 될 경우 선택한 리전과 가용영역의 데이터 센터 내 host computer에서 hypervisor 위에 고객의 요청에 의해 insatnce를 생성하여 제공하는 방식입니다.

여기서 만약 hypervisor와 instance간의 Network이 끊긴다면..? 아니면 Host 장비에 불이 난다면...?

**와장창-!** 말 그대로 인스턴스가 와장창 납니다.

 이러한 갑작스러운 이슈로 인해 발생하는 AWS 하드웨어의 Maintenance Event 혹은 System checkfailed 이슈로 인해 발생하는 예기치않은 이슈에 대해 정리하고 사례에 맞춰 사용자들은 어떻게 대처해야하는지에 경험을 공유하고자 합니다.



들어가기 앞서 모든 AWS Maintenance 는 일정을 조정하는 것이 가능하다는 점 참고해주시면 되겠습니다.



## AWS Maintenance

우선 AWS에서의 EC2 Event 종류와 Cloudwatch에서 확인할 수 있는 Status Check failed 지표는 아래와 같은 내용을 포함합니다.
  - AWS Event 
    - Instance stop : 예약된 시간에 인스턴스가 중지됩니다. 인스턴스를 다시 시작하면 **새 호스트로 마이그레이션됩니다.** 
    
    이러한 유형은 Amazon EBS가 지원하는 인스턴스에만 적용됩니다.
    
    - Instance retirement 
    - Instance reboot
    - System reboot 
    - System maintenance 

### Instance stop 

: 예약된 시간에 인스턴스가 중지됩니다. 인스턴스를 다시 시작하면 **새 호스트로 마이그레이션됩니다.** 

Instance stop이 일어나는 경우는 대게  Host hardware의 폐기 날이 결정된 것입니다.

이 경우, Maintenance 일정 이전에 스스로 stop/start를 진행하여 해소 할 수 있습니다.

두 눈을 크게 뜨고 정확히 봐야합니다.  Instance reboot이 아닌, Stop인 것을요.

Stop되어있는 인스턴스는 어떤 트리거가 발생하기 전까지는 결코 혼자서 벌떡 일어나진 않습니다.

    이러한 유형은 Amazon EBS가 지원하는 인스턴스에만 적용됩니다.



참고로 PHD(persnal Health Dashborad)에서 성능저하로 인해 예약된 이벤트들의 경우 되도록 빨리 인스턴스를 재부팅하여 새 호스트로 마이그레이션하는 것이 좋습니다. 



이미 성능이 저하된 호스트 하드웨어이기에 언제 어떤이슈가 발생할지 모르는 폭탄이기 때문입니다.



### Instance retirement 

: 예약된 시간에 인스턴스가 Amazon EBS에서 지원되는 경우 중지되거나 인스턴스 스토어에서 지원되는 경우 종료됩니다.

말 그대로 EBS 지원 인스턴스는 stop, 인스턴스스토어 지원 인스턴스는 terminate되는 이벤트입니다.

아직 발생해본적이 없어서 패스하겠습니다. (뭐..다를거 있겠냐만..)

### System maintenance 

: 예약된 시간에 네트워크 또는 전력 유지 관리로 인스턴스가 일시적인 영향을 받을 수 있습니다

네트워크 유지 관리 시에는 예약된 인스턴스의 네트워크 연결이 잠시 동안 끊어집니다. 유지 관리가 완료되면 인스턴스의 네트워크 연결이 평소처럼 복구됩니다.

전력 유지 관리 시에는 예약된 인스턴스가 잠시 동안 오프라인 상태로 전환되었다가 재부팅됩니다. 재부팅 이후에도 인스턴스의 모든 구성 설정은 그대로 유지됩니다.



이제 가장 주로 겪은 두가지 이벤트를 다뤄보겠습니다.

하이라이트 입니다. 

### Instance reboot 
: 예약된 시간에 인스턴스가 재부팅됩니다.

말그대로 인스턴스의 재부팅을 의미하기에 os에서 reboot하는것과 동일하게 동작합니다.

메인터넌스 일정 이내에 사용자가 스스로 reboot을 먼저 실행하여 해소하는 방법과 메인터넌스 일정에 자연스럽게 해소하는 방법이 있습니다. EBS 볼륨의 데이터는 영향을 받지 않습니다.



유의사항으로는 인스턴스 재부팅 시 인스턴스스토어 볼륨 데이터와 public IP가 변경되기에 Elastic IP를 할당하여 고정 IP를 사용하고

만약 인스턴스스토어 볼륨을 사용한다면 미리 데이터를 백업해놓아야 합니다.

### System reboot 
: 예약된 시간에 인스턴스의 호스트가 재부팅됩니다.

인스턴스의 재부팅이 아닌, 인스턴스가 올라가있는 호스트 하드웨어의 재부팅입니다.

일반적인 사용자가 스스로 이벤트를 해소할 수 있는 방법이 없습니다.

~~(일반적이지 못한 경우 : 인스턴스 위치를 어떻게든 찾아서 업체점검으로 속이고 치..침투하여 리붓)~~

농담이고, AMI를 생성해서 다시 만들면 메인터넌스를 회피할 수 있습니다. (Instance reboot과 동일하게 Elastic IP 유지필요, 인스턴스스토어 볼륨 데이터 증발)

필요에 의하지 않다면 AWS에 온전히 작업을 맡기는 것이 좋을 것 같습니다. 

다행히도 AWS가 시스템을 재부팅해도 DNS 이름이나 IP 주소와 같은 구성이 변경되지 않으며, 로컬 인스턴스 스토어에 저장된 데이터도 그대로 보존됩니다.



통상 이러한 재부팅들은 수 분 내에 끝난다고 말하지만 대부분의 경우 3분안에 이벤트가 종료되었던 것으로 경험했습니다.

모든 경우에서 서비스 서버(EC2)들은 AMI나 Snapshot을 통해 백업해두는 것이 가장 현명합니다.



이제 메인 빌런인 **갑작스러운 하드웨어 이슈에 의한 EC2 Reboot** 입니다.

보통 잘자다가 새벽에 천둥같은 알람이 울면 인스턴스의 모니터링 지표에 (System, Instance) Status check failed 알람이 발생하는 경우도 있습니다.

이게 무엇인고하니,  AWS는 두 가지 상태 확인을 통해 각 EC2 인스턴스 상태를 내부 모니터링 툴을 사용하여 모니터링합니다. 

자세한 내용은 AWS Docs에 잘나와있으니 축약하여 메모해놓겠습니다.

- 요약
  - 시스템 상태 확인 실패는 인스턴스가 실행되는 AWS 시스템에 문제가 있음을 나타냅니다.  (하드웨어 이슈)
  - 인스턴스 상태 확인 실패는 대게 OOM(OutOfMemory) 등 리소스 이슈 혹은 잘못된 OS config 수정에 의해 발생합니다. (OS 이슈) ~~(간혹 커널)



그렇기에 만약 인스턴스가 죽어서 Cloudwatch의 메트릭에서 위와같은 상태 검사 메트릭을 우선 확인한 뒤,

CPU, memory (Custom Metric으로 받아와야합니다.), Volume IO 등 리소스 사용량과 콘솔 상에서 확인할 수 있는 시스템 로그를 통해 dmsg 로그 확인 및 본인이 마지막으로 서버에 무슨 작업을 했는지 확인해야하고

시스템 상태검사 실패라면 재빠르게 stop/start 혹은 해당 이벤트를 트리거로 걸어두어 자동 reboot 작업을 걸어두는 것이 좋습니다.

[AWS 인스턴스 상태 모니터링 링크](https://docs.aws.amazon.com/ko_kr/AWSEC2/latest/WindowsGuide/monitoring-instances-status-check.html)



그럼 AWS 이슈는 여기서 정리하도록 하고 GCP를 살짝 자랑해보려합니다.

~~(AWS 좋아요 사랑해요)~~ 



##  GCP Maintenance

GCP의 Compute Engine은 소프트웨어 또는 하드웨어 업데이트와 같은 호스트 시스템 이벤트가 발생하더라도 가상 머신 인스턴스가 계속 실행될 수 있게 해주는 라이브 마이그레이션 기능을 제공합니다.

Compute Engine은 사용자가 VM을 재부팅할 필요 없이 동일 영역에서 실행 중인 인스턴스를 또 다른 호스트로 라이브 마이그레이션합니다.



 이렇게 해서 Google은 사용자의 VM에 영향을 주지 않으면서도 인프라를 보호하고 안정적인 상태로 유지하는 데 반드시 필요한 유지보수를 수행할 수 있습니다. (GPU가 연결된 인스턴스는 불가능하다는 점 !)



다만 GCP도 역시 Host Error가 발생합니다.  여러분 세상에 100% 안죽는 서버는 없습니다.  ~~(사장님 저는 안죽습니다)~~

그러니 너무 스트레스 받아하지 마세요. 어쩔 수 없는걸요.

그렇기에  항시 대비하고 있어야 합니다. 소 잃고 외양간 고치는 것보다 소가 도망쳐도 다시 잡을 수 있게 위치 추적기를 심는게 중요합니다. 

서버 한 두대가 죽어도 서비스는 유지될 수 있도록 고가용성 구조를 구성하시는게 가장 좋지만 여러 어른들의 사정에 의해 불가능하다면 최소한 모니터링을 걸어두어 서비스의 빠른 Recovery가 중요합니다.



감사합니다.

