<!doctype html><html class=no-js lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=theme-color content="#1b1b1b"><title>GCP-Cloud Load Balancer(2) 테스트 | 255.255.248.0</title><script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script><meta name=description content><meta property="og:title" content="GCP-Cloud Load Balancer(2) 테스트"><meta property="og:description" content="GCP CLB 1편 포스팅에 이어 기능들을 테스트해봤습니다."><meta property="og:type" content="article"><meta property="og:url" content="https://21sub.net/post/gcp/gcp_clb_2/"><meta property="og:image" content="https://21sub.net/post/gcp/gcp_clb_2/featured.png"><meta itemprop=name content="GCP-Cloud Load Balancer(2) 테스트"><meta itemprop=description content="GCP CLB 1편 포스팅에 이어 기능들을 테스트해봤습니다."><meta itemprop=wordCount content="452"><meta itemprop=image content="https://21sub.net/post/gcp/gcp_clb_2/featured.png"><meta itemprop=keywords content="gcp,public cloud,"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://21sub.net/post/gcp/gcp_clb_2/featured.png"><meta name=twitter:title content="GCP-Cloud Load Balancer(2) 테스트"><meta name=twitter:description content="GCP CLB 1편 포스팅에 이어 기능들을 테스트해봤습니다."><link rel=stylesheet href=/css/bundle.css><link rel=stylesheet href=/css/custom.css><link rel=icon href=/icons/16.png sizes=16x16 type=image/png><link rel=icon href=/icons/32.png sizes=32x32 type=image/png><link rel=manifest href=/manifest.json><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-199142344-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script></head><body class="body kind-page"><header class=header><a class=logo href=/>255.255.248.0</a><nav class="main-nav main-nav--right" role=navigation><button id=toggle class=main-nav__btn aria-label="Menu toggle" aria-expanded=false tabindex=0><div class=main-nav__btn-box tabindex=-1><svg class="main-nav__icon icon-menu" width="18" height="18" viewBox="0 0 18 18"><path class="icon-menu__burger" d="M18 0v3.6H0V0h18zM0 10.8h18V7.2H0v3.6zM0 18h18v-3.6H0V18z"/><path class="icon-menu__x" d="M11.55 9 18 15.45 15.45 18 9 11.55 2.55 18 0 15.45 6.45 9 0 2.55 2.55.0 9 6.45 15.45.0 18 2.55 11.55 9z"/></svg></div></button><ul id=menu class=main-nav__list><li class=main-nav__item><a class=main-nav__link href=/about_dominic/><span class=main-nav__text>About Dominic</span></a></li><li class=main-nav__item><a class=main-nav__link href=/post/certificate/aws-saa/><span class=main-nav__text>AWSKRUG beginner group Study 관련</span></a></li></ul></nav></header><div class=primary><main class=main><nav class="breadcrumb block" aria-label=breadcrumb><ol class=breadcrumb__list><li class=breadcrumb__item><a class=breadcrumbs__link href=/>21sub.net</a></li><li class=breadcrumb__item><a class=breadcrumbs__link href=/post/>Posts</a></li><li class="breadcrumbs__item breadcrumb__item--active" aria-current=page>GCP-Cloud Load Balancer(2) 테스트</li></ol></nav><div class="single block"><article class=entry><figure class="entry__featured featured"><img class=featured__img src=/post/gcp/gcp_clb_2/featured.png alt=featured.png></figure><div class="entry__meta meta mb"><span class="entry__meta-categories meta-categories"><span class=meta-categories__list>Categories:
<a class=meta-categories__link href=/categories/cloud/ rel=category>cloud</a></span></span></div><h1 class=entry__title>GCP-Cloud Load Balancer(2) 테스트</h1><div class=entry__content><p>GCP CLB 1편 포스팅에 이어 기능들을 테스트해봤습니다.</p><h2 id=배경>배경</h2><p>앞서 1편에서 각기 LB들의 서비스 특징과 workflow에 대해 정리했다면
이번 글은 실제 서비스에서 GCP LB를 사용해보면서 진짜(?) 기능이 동작하는지, 실제로 핸즈온하며 체크해볼 예정입니다.</p><pre><code>목차
[1. HTTP/s LB 테스트]
[2. TCP LB 테스트]
[3.TCP porxy LB 테스트]
</code></pre><hr><h3 id=인스턴스-그룹-생성><strong>[인스턴스 그룹 생성]</strong></h3><p><img src=/img/ig.jpg alt="This is an image"></p><p>기본적으로 백엔드 서비스는 UIG로 생성할 예정이며 단일 존 내부에 두대의 Web service를 띄워 확인해보겠습니다.</p><h3 id=상태-검사-생성><strong>[상태 검사 생성]</strong></h3><p><img src=/img/hc_set.jpg alt="This is an image"></p><p>우선 Http-80으로 상태 검사를 진행할 예정입니다. 고고</p><h2 id=https-lb-test>HTTP/s LB-Test</h2><h3 id=lb-생성>LB 생성</h3><h3 id=http-backend-생성><strong>[HTTP Backend 생성]</strong></h3><p><img src=/img/Http_back.jpg alt="This is an image"></p><h3 id=http-검토-및-확인><strong>[HTTP 검토 및 확인]</strong></h3><p><img src=/img/Http_last.jpg alt="This is an image"></p><p>나머지 LB들도 동일하게 구성하면 되기에 configuration에 대한 내용은 여기까지&mldr;! Test 를 하러갑시다.</p><p>(TCP LB는 그룹이 아닌 인스턴스 Pool로 등록 / TCP LB생성 간 단일리전으로 선택하면 TCP proxy가 아닌 TCP LB로 구성을 도와줍니다.)</p><h3 id=test-1-health-check-확인>Test 1. Health check 확인</h3><p><img src=/img/test_hc.jpg alt="This is an image"></p><p>LB를 생성하고 나면 정상상태의 인스턴스가 확인되지 않는다. 당연히 80포트의 데몬이 떠있질 않으니, 헬스체크가 안되는겁니다.
우선 인스턴스 방화벽에서 35.191.0.0/16,130.211.0.0/22 80 Ingress를 허용해준 뒤, 얼른 서버로 접근하여 httpd를 띄워봅시다~</p><hr><p><img src=/img/http_index.jpg alt="This is an image"></p><p>http 데몬을 올린 뒤, 설정해둔 상태검사 포인트만큼 수십초를 기다리면 금방 헬스체크가 되는 모습을 볼 수 있습니다.
<img src=/img/http_hc_g.jpg alt="This is an image">
<img src=/img/HTTP_test.jpg alt="This is an image"></p><h3 id=loadbalancing-test>Loadbalancing Test</h3><p>부하분산이 정상적으로 이뤄지고 있는지 확인해봅시다.
F5를 다다다닷 누르기는 싫어서 curl을 실행하는 간단한 스크립트를 통해 확인해본 결과,</p><pre><code>#!/bin/bash

number=0
while [ $number -le 50 ]
do
curl 34.98.79.168 &gt;&gt; $(date +&quot;%y%m%d&quot;).txt
sleep 3
  ((number++))
done

</code></pre><p>Web 1번 22회, Web 2 29회가 확인됩니다. 왜 정확히 반반 나뉘지 않는걸까요?</p><p><strong>-# GCP의 설명 #-</strong></p><p><strong>"- 기본적으로 균등하게 부하를 분산하지만, 아주 작은 수의 요청은 균등하게 분배되지 않을 수 있습니다"</strong></p><p>&mldr;흠..🤣🤣🤣🤣🤣🤣</p><h3 id=access-log-확인>Access log 확인</h3><p>그럼 실제 서버에서는 어떻게 요청이 오는지 Access.log를 통해 확인해보겠습니다.
<img src=/img/access_log_1.jpg alt="This is an image"></p><p>HC 대역인 35.191.0.0/16으로 Healthcheck와 Client의 요청과 결과가 잘 찍혀있네요.</p><p>왜 HC 대역이 access log에 남는걸까요?
실제 부하 분산 트래픽의 소스 IP 주소는 상태 확인 프로브 IP 범위와 같기 때문입니다.</p><p>부하 분산기는 수신 연결을 종료한 후 부하 분산기에서 백엔드로 새 연결을 엽니다.</p><p>이후 target proxy에서 URL map을 통해 백엔드 서비스쪽으로 reverse proxy하기에 백엔드 서비스는 실제 Source IP를 알 수 없는겁니다.</p><p>Source IP가 필요하다면 X-forward-for Header를 통해 확인 할 수 있습니다.</p><h3 id=http-backend-session-affinity>HTTP backend session affinity</h3><p><img src=/img/cookie_2.jpg alt="This is an image"></p><p>생성해놨던 HTTP LB의 백엔드 구성에서 cookie를 생성해줍니다.
생성된 쿠키 어피니티가 설정되면 LB가 첫 번째 요청에서 쿠키를 생성합니다.
LB는 동일한 쿠키를 사용하는 각 후속 요청에서 같은 백엔드 VM 또는 엔드포인트로 요청을 전달합니다.</p><p><img src=/img/cookie.jpg alt="This is an image"></p><p>GCLB라는 cookie가 확인됩니다. 쿠키 값을 통해 고정 세션을 유지할 수 있습니다. 영원히 세션이 고정되는것은 아닙니다.
Timeout으로 설정해둔 (HTTP는 Keep AliveTimeout값이 제한 시간 값을 따라갑니다.) 30초 후엔 새로운 세션이 연결됩니다.</p><p><img src=/img/cookie_3.jpg alt="This is an image"></p><p>위 결과, (31초 후 curl -i 동작) 31초마다 세션이 바뀌는걸 확인할 수 있습니다.</p><h3 id=ssl-offloading>SSL offloading</h3><p>CLB 1번 포스팅에 안적어 놓은것 같습니다. 당연하게도..SSL Offloading을 지원합니다. 그걸 해볼겁니다.</p><p>AWS에서는 ACM 에서 발급이 가능했다면 GCP 또한 google Managed SSL 인증서를 지원합니다.</p><p>Google 관리형 SSL 인증서는 도메인에서 Google Cloud가 가져오고 관리하는 도메인 유효성 검사(DV) 인증서입니다. 각 인증서에서 여러 호스트 이름을 지원하며 Google은 인증서를 자동으로 갱신합니다.</p><p>이를 통해 External HTTPs LB, SSL proxy LB를 구성할 수 있습니다.</p><p>​</p><h2 id=tcp-proxy-lb-test>TCP proxy LB-Test</h2><h2 id=tcp-lb-test>TCP LB-Test</h2></div><footer class=entry__footer><div class=entry__tags><a class="entry__tag btn" href=/tags/gcp/>gcp</a>
<a class="entry__tag btn" href=/tags/public-cloud/>public cloud</a></div></footer></article></div></main><div class="authorbox block"><div class=author><figure class=author__avatar><img class=author__img alt="Dominic avatar" src=/img/avatar.png height=90 width=90></figure><div class=author__body><div class=author__name>Dominic</div><div class=author__bio>Dominic's true identity is unknown. Maybe he is a cute fairy or slave :D</div></div></div></div><div class="related block"><h3 class=related__title>Related</h3><ul class=related__list><li class=related__item><a class=related__link href=/post/gcp/gcp_clb_1/>GCP-Cloud Load Balancer(1) 내용정리</a></li><li class=related__item><a class=related__link href=/post/gcp/gcp_docker-1/>Hello, Docker 기초!</a></li><li class=related__item><a class=related__link href=/post/gcp/gcp_vpc/>Network 기초(VPC) - GCP</a></li><li class=related__item><a class=related__link href=/post/gcp/gcp_issue/>아니 글쎄 갑자기 인스턴스가 죽었다니까요? - GCP</a></li><li class=related__item><a class=related__link href=/post/certificate/aws-saa/>AWSKRUG beginner group Study 관련</a></li></ul></div><section class="comments block"><div id=disqus_thread></div><script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return;}
var d=document,s=d.createElement('script');s.async=true;s.src='//'+"dominic"+'.disqus.com/embed.js';s.setAttribute('data-timestamp',+new Date());(d.head||d.body).appendChild(s);})();</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></section></div><footer class=footer><div class="footer__social social"><a class=social__link target=_blank rel="noopener noreferrer" href=https://www.instagram.com/seob.199b><svg class="social__icon" aria-label="Instagram" role="img" width="32" height="32" viewBox="0 0 512 512"><g fill="none" stroke-width="29"><rect height="296" rx="78" width="296" x="108" y="108"/><circle cx="256" cy="256" r="69"/></g><circle cx="343" cy="169" r="19"/></svg></a><a class=social__link target=_blank rel="noopener noreferrer" href=https://linkedin.com/in/hanseob-lee-9655781aa><svg class="social__icon" aria-label="LinkedIn" role="img" width="32" height="32" viewBox="0 0 512 512"><circle cx="142" cy="138" r="37"/><path stroke-width="66" d="M244 194v198M142 194v198"/><path d="M276 282c0-20 13-40 36-40 24 0 33 18 33 45v105h66V279c0-61-32-89-76-89-34 0-51 19-59 32"/></svg></a><a class=social__link target=_blank rel="noopener noreferrer" href=https://github.com/D0min1c><svg class="social__icon" aria-label="Github" role="img" width="32" height="32" viewBox="0 0 512 512"><path d="M335 499c14 0 12 17 12 17H165s-2-17 12-17c13 0 16-6 16-12l-1-50c-71 16-86-28-86-28-12-30-28-37-28-37-24-16 1-16 1-16 26 2 40 26 40 26 22 39 59 28 74 22 2-17 9-28 16-35-57-6-116-28-116-126 0-28 10-51 26-69-3-6-11-32 3-67 0 0 21-7 70 26 42-12 86-12 128 0 49-33 70-26 70-26 14 35 6 61 3 67 16 18 26 41 26 69 0 98-60 120-117 126 10 8 18 24 18 48l-1 70c0 6 3 12 16 12z"/></svg></a></div><div class=footer__copyright>© 2021 Binario. <span class=footer__copyright-credits>Powered by <a href=https://gohugo.io/ rel="nofollow noopener" target=_blank>Hugo</a> and <a href=https://github.com/vimux/binario rel="nofollow noopener" target=_blank>Binario</a> theme.</span></div></footer><script src=/js/menu.js></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.6/MathJax.js?config=TeX-AMS-MML_HTMLorMML" async></script><script src=/js/custom.js></script></body></html>