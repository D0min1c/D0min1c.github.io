<!doctype html><html><head><title>세대를 교체중입니다. -AWS</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="ie=edge"><link rel=stylesheet href=/css/bootstrap.min.css><link rel=stylesheet href=/css/layouts/main.css><link rel=stylesheet href=/css/navigators/navbar.css><link rel=stylesheet href=/css/plyr.css><link rel=stylesheet href=/css/flag-icon.min.css><link href="https://fonts.googleapis.com/css2?family=Muli:wght@300;400;500;600" rel=stylesheet><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.min.css><link rel=icon type=image/png href=/images/site/favicon_hu1d79931af21da1953430965fd067c561_13812_42x0_resize_q75_box.JPG><meta property="og:title" content="세대를 교체중입니다. -AWS"><meta property="og:description" content="Sample post with multiple images, embedded video ect."><meta property="og:type" content="article"><meta property="og:url" content="https://hugo-toha.github.io/posts/cloud/aws/awsgeneration/"><meta property="article:published_time" content="2021-06-30T00:00:00+00:00"><meta property="article:modified_time" content="2021-06-30T00:00:00+00:00"><meta name=description content="Sample post with multiple images, embedded video ect."><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/styles/atom-one-dark.min.css><link rel=stylesheet href=/css/layouts/single.css><link rel=stylesheet href=/css/navigators/sidebar.css><link rel=stylesheet href=/css/style.css><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-199142344-2','auto');ga('send','pageview');}</script></head><body data-spy=scroll data-target=#TableOfContents data-offset=80><div class="container-fluid bg-dimmed wrapper"><nav class="navbar navbar-expand-xl top-navbar final-navbar shadow"><div class=container><button class="navbar-toggler navbar-light" id=sidebar-toggler type=button onclick=toggleSidebar()>
<span class=navbar-toggler-icon></span></button>
<a class=navbar-brand href=/><img src=/images/site/main-logo_hu1d79931af21da1953430965fd067c561_13812_42x0_resize_q75_box.JPG alt=Logo>
255.255.248.0</a>
<button class="navbar-toggler navbar-light" id=toc-toggler type=button onclick=toggleTOC()>
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse lang-selector" id=top-nav-items><ul class="navbar-nav ml-auto"></ul></div></div><img src=/images/site/main-logo_hu1d79931af21da1953430965fd067c561_13812_42x0_resize_q75_box.JPG class=d-none id=main-logo alt=Logo>
<img src=/images/site/inverted-logo_hu1d79931af21da1953430965fd067c561_13812_42x0_resize_q75_box.JPG class=d-none id=inverted-logo alt="Inverted Logo"></nav><section class=sidebar-section id=sidebar-section><div class=sidebar-holder><div class=sidebar id=sidebar><form class=mx-auto method=get action=/search><input type=text name=keyword placeholder=Search data-search id=search-box></form><div class=sidebar-tree><ul class=tree id=tree><li id=list-heading><a href=/posts data-filter=all>Posts</a></li><div class=subtree><li><a href=/posts/about_dominic/ title=😎About_dominic😎>😎About_dominic😎</a></li><li><i class="fas fa-minus-circle"></i><a class=active href=/posts/cloud/>Cloud</a><ul class=active><li><i class="fas fa-minus-circle"></i><a class=active href=/posts/cloud/aws/>AWS</a><ul class=active><li><a href=/posts/cloud/aws/awshost_issue/ title="AWS 이슈 (갑.서.박)">AWS 이슈 (갑.서.박)</a></li><li><a class=active href=/posts/cloud/aws/awsgeneration/ title="인스턴스 세대교체 - AWS">인스턴스 세대교체 - AWS</a></li></ul></li><li><i class="fas fa-plus-circle"></i><a href=/posts/cloud/gcp/>GCP</a><ul><li><a href=/posts/cloud/gcp/gcpissue-1/ title="GCP 이슈 (갑.서.박)">GCP 이슈 (갑.서.박)</a></li><li><a href=/posts/cloud/gcp/gcp-clb/ title=GCP-CLB>GCP-CLB</a></li><li><a href=/posts/cloud/gcp/gcp-vpc/ title=GCP-VPC>GCP-VPC</a></li><li><a href=/posts/cloud/gcp/k8sgke-pod/ title=k8s(GKE-Pod)>k8s(GKE-Pod)</a></li><li><a href=/posts/cloud/gcp/k8sgke-service/ title=k8s(GKE-Service)>k8s(GKE-Service)</a></li><li><a href=/posts/cloud/gcp/k8sgke-volume/ title=k8s(GKE-volume)>k8s(GKE-volume)</a></li></ul></li></ul></li><li><i class="fas fa-plus-circle"></i><a href=/posts/kubernetes/>Kubernetes</a><ul><li><a href=/posts/kubernetes/k8snetworking/ title=k8s(Networking)>k8s(Networking)</a></li><li><a href=/posts/kubernetes/k8scomponent/ title=k8s(component)>k8s(component)</a></li><li><a href=/posts/kubernetes/k8singress/ title=k8s(Ingress)>k8s(Ingress)</a></li><li><a href=/posts/kubernetes/k8svolume/ title=k8s(Volume)>k8s(Volume)</a></li></ul></li><li><i class="fas fa-plus-circle"></i><a href=/posts/certification/>Certification</a><ul><li><i class="fas fa-plus-circle"></i><a href=/posts/certification/cka/>CKA</a><ul><li><a href=/posts/certification/cka/namespace/ title="Namespace hands-on">Namespace hands-on</a></li><li><a href=/posts/certification/cka/pod/ title="Pod hands-on">Pod hands-on</a></li><li><a href=/posts/certification/cka/replicasets/ title="ReplicaSets hands-on">ReplicaSets hands-on</a></li><li><a href=/posts/certification/cka/deployments/ title="Deployments hands-on">Deployments hands-on</a></li></ul></li></ul></li></div></ul></div></div></div></section><section class=content-section id=content-section><div class=content><div class="container p-0 read-area"><div class="hero-area col-sm-12" id=hero-area style=background-image:url(https://hugo-toha.github.io/posts/cloud/aws/awsgeneration/images/host_thumnail.jpg)></div><div class=page-content><div class="author-profile ml-auto align-self-lg-center"><img class=rounded-circle src=/images/author/dominic_hue8656283646074d0d4d459b13fee860e_56605_120x120_fit_box_2.png alt="Author Image"><h5 class=author-name>dominic</h5><p>June 30, 2021</p></div><div class=title><h1>세대를 교체중입니다. -AWS</h1></div><div class=post-content id=post-content><p>AWS EC2의 nitro 타입과 세대 변경 간 확인해야되는 부분 등 경험을 기록해봤습니다.</p><h2 id=배경>배경</h2><p>AWS에서 t2와 같은 구세대 인스턴스를 최신 세대의 인스턴스로 마이그레이션하는 고객들의 기억을 되살리며 메모해둡니다.</p><p>EC2 instance의 가상화 기술은 Xen PV 으로 시작하여 Xen HVM 을거쳐 Nitro 까지 발전을 거듭해왔습니다
AWS의 인스턴스는 크게 Xen 기반의 구세대 인스턴스와 Nitro 시스템 (KVM)기반의 신세대 인스턴스로 나뉩니다.</p><h3 id=무슨-차이가-있는지>무슨 차이가 있는지?</h3><p>짧고 굵게 설명하자면, 이전 세대 대비 저렴한 비용 그와 반대되는 성능적 차이가 있습니다.
메모리, CPU의 할당을 관리하고 대부분의 워크로드에있어서 베어 메탈과 거의 유사한 성능을 제공하는 하이퍼바이저라고 설명합니다.</p><p>5세대 인스턴스들은 모두 Nitro 시스템이 도입되어 있기에 이전 세대의 인스턴스와는 다른 드라이버들이 존재합니다.</p><ul><li><p>로컬 NVMe 스토리지</p><ul><li>새로운 C5d, M5d 및 베어 메탈 EC2 인스턴스에는 Xen 가상화 I3 및 F1 인스턴스에도 사용되는 Nitro 로컬 NVMe 스토리지 구성 요소가 포함됩니다. 이 구성 요소는 PCI 인터페이스를 통해 고속 로컬 스토리지에 대한 직접 액세스를 제공하며, 모든 데이터를 전용 하드웨어를 사용하여 투명하게 암호화합니다. 또한 스토리지 디바이스와 EC2 인스턴스를 하드웨어 레벨에서 분리하여 베어 메탈 인스턴스에서 로컬 NVMe 스토리지의 이점을 활용할 수 있도록 합니다.</li></ul></li><li><p>Nitro 보안 칩</p><ul><li>AWS 서버 설계에 포함되는 구성 요소로, 하드웨어 리소스를 지속적으로 모니터링하고 보호하며 시스템을 부팅할 때마다 독립적으로 펌웨어를 확인합니다.</li></ul></li><li><p>Nitro 하이퍼바이저</p><ul><li>메모리 및 CPU 할당을 관리하고 대부분의 워크로드에 베어 메탈과 거의 유사한 성능(Netflix의 Brendan Gregg는 이 성능을 1% 미만으로 벤치마킹함)을 제공하는 대기 휴지 상태의 씬 하이퍼바이저입니다.</li></ul></li><li><p>네트워킹</p><ul><li>각 VPC(가상 프라이빗 클라우드) 내의 소프트웨어 정의 네트워크에 대한 하드웨어 지원, 향상된 네트워킹 및 탄력적 네트워크 어댑터(ENA)를 제공합니다.</li></ul></li><li><p>탄력적 블록 스토리지</p><ul><li>CPU 집약형 암호화 작업을 포함한 하드웨어 EBS 처리 기능을 제공합니다.
스토리지, 네트워킹 및 보안 기능을 하드웨어로 이동하면 베어 메탈 및 가상 인스턴스 유형에서 다음과 같은 이점을 실현할 수 있습니다.</li></ul></li><li><p>가상 인스턴스의 경우 하이퍼바이저의 역할이 크게 감소하므로 모든 호스트의 CPU 성능 및 메모리를 게스트 운영 체제에 제공할 수 있습니다.</p></li><li><p>베어 메탈 인스턴스는 하드웨어에 완벽하게 액세스할 수 있을 뿐 아니라 가상 EC2 인스턴스와 동일한 유연성 및 기능 세트(예: CloudWatch 지표, EBS 및 VPC)를 활용할 수 있습니다.</p></li></ul><p><a href=https://aws.amazon.com/ko/blogs/korea/amazon-ec2-update-additional-instance-types-nitro-system-and-cpu-options/>AWS NitroSystem-1</a></p><p><a href=https://aws.amazon.com/ko/ec2/nitro/>AWS NitroSystem-2</a></p><p>구구절절한것들 말고 실질적으로 이전 세대에서 신세대 인스턴스로 옮기는데 확인이 필요한 부분은 아래 두가지 입니다.</p><h3 id=1-network-드라이버>1. Network 드라이버</h3><p>ENA를 도입했습니다. 기본적은 네트워크모듈인 ENA (Elastic Network Adapter)는 기존 ENI보다 향상된 네트워킹 성능을 제공합니다.
가령, 네트워크 지연시간을 줄이고, PPS 성능이 높아진 모듈이라고 생각하면 편할듯합니다.</p><h3 id=2-storage-드라이버>2. Storage 드라이버</h3><p>Nitro 시스템 기반 인스턴스에서는 EBS 볼륨이 NVMe(Non-Volatile Memory express) 블록 디바이스로 표시됩니다.</p><p>NVMe는 PCIe 버스를 통해 작동 하므로 특성은 하드디스크가 아닌 고속 메모리에 가깝다고 할 수 있습니다.</p><p>NVMe 볼륨을 사용하기에 그에맞는 드라이버가 필요합니다.</p><h3 id=3-check-point>3. [check point]</h3><ol><li>내 인스턴스의 버전 확인
내 인스턴스의 uptime을 확인해야 합니다. 기본적으로 4세대 인스턴스에는 최신 세대 인스턴스 유형을 지원하는 드라이버 및 구성이 포함되어있지 않았습니다. 2018년 8월 이후의 인스턴스에는 최신 세대 인스턴스 유형을 지원하는 드라이버 및 구성이 포함됩니다.</li></ol><h2 id=결론>결론</h2><p>위에서 인스턴스 버전을 확인해본 결과,, 2018년 8월 이전에 생성된 인스턴스라면 위 드라이버들을 수동으로 설치해줘야 합니다.</p><ol><li><p>Window 인스턴스를 업그레이드하려는 경우
인스턴스에서 어느 네트워크 드라이버가 실행되고 있는지 확인해야 합니다. PV 네트워크 드라이버는 사용자가 원격 데스크톱을 사용하여 인스턴스에 액세스할 수 있게 해줍니다. Windows Server 2008 R2부터 인스턴스는 AWS PV, intel Network Adapter 또는 Enhanced Networking 드라이버를 사용합니다. Windows Server 2003 및 Windows Server 2008의 인스턴스는 Citrix PV 드라이버를 사용합니다.</p></li><li><p>Linux 인스턴스를 업그레이드 하는 경우
ENA(Elastic Network Adapter) enaSupport 속성이 활성화되어있는지 확인해야합니다.</p></li><li><p>가능하다면 NitroInstanceChecks script 스크립트 실행하시는게 제일 편합니다.
AWS에서 제공하는 스크립트를 실행하고 업그레이드를 위해 무엇이 필요한지 확인하면됩니다.</p></li></ol><p><a href=https://github.com/awslabs/aws-support-tools/tree/master/EC2/NitroInstanceChecks>NitroInstanceChecks링크</a></p><ul><li>위 스크립트는 아래 OS버전에서 지원합니다.<ul><li>Red Hat 계열: Red Hat Linux, Red Hat Enterprise Linux, CentOS</li><li>Amazon Linux, Amazon Linux 2</li><li>Debian 계열: Debian, Ubuntu</li></ul></li></ul><h2 id=모든-변경사항을-발생시키기-전-ami-풀백업은-필수>모든 변경사항을 발생시키기 전 AMI 풀백업은 필수</h2><p>업그레이드가 모종의 이유로 실패할 경우를 대비하여 항상 백업본을 유지한 채 작업을 진행합시다.</p><p>실제로 점검시간 내 세대변경 작업이 완료되지않아 이슈가 발생한 적이 있었습니다.
Dev서버였기에 가장 최근의 백업본이 3일전의 이미지였기에
해당 dev서버의 root 볼륨을 테스트인스턴스에 연결해서 수정했던 기억이 나네요. 스크립트를 돌려보고 작업헀어야헀는데,
안일했습니다. 덕분에 점검시간을 30분이나 늘렸으니 말이죠.</p><h2 id=마지막으로>마지막으로</h2><p>간혹 5세대 인스턴스의 NVMe에서 timeout에 의해 I/O작업이 멈춘 이슈도 있었습니다.
대충 이런 순서로 장애가 발생했던 것으로 기억합니다.</p><p>Instance Hardware 이슈 발생 -> 이슈타임 간 EBS 이슈 발생 -> NVMe Timeout ->Instance Hardware 이슈 해소 -> NVMe timeout으로 인한 부팅 실패 -> 상태유지 -> 담당자 아침에 출근하여 리붓으로 해소</p><p>일단은 부트파라미터에서 nvme.io_timeout값을 최대값으로 변경하여 이후 이슈는 없었지만
악재의 악재가 겹치는 상황이였기에 당시 꽤나 당황스러운 이슈였습니다.</p><p>겪었던 사례들을 메모해봤습니다.</p><p>감사합니다.</p></div><hr><div class="row next-prev-navigator"></div><hr></div></div></div><a id=scroll-to-top class=btn><i class="fas fa-chevron-circle-up"></i></a></section><section class=toc-section id=toc-section><div class=toc-holder><h5 class="text-center pl-3">Table of Contents</h5><hr><div class=toc><nav id=TableOfContents><ul><li><a href=#배경>배경</a><ul><li><a href=#무슨-차이가-있는지>무슨 차이가 있는지?</a></li><li><a href=#1-network-드라이버>1. Network 드라이버</a></li><li><a href=#2-storage-드라이버>2. Storage 드라이버</a></li><li><a href=#3-check-point>3. [check point]</a></li></ul></li><li><a href=#결론>결론</a></li><li><a href=#모든-변경사항을-발생시키기-전-ami-풀백업은-필수>모든 변경사항을 발생시키기 전 AMI 풀백업은 필수</a></li><li><a href=#마지막으로>마지막으로</a></li></ul></nav></div></div></section></div><footer class="container-fluid text-center align-content-center footer pb-2"><div class="container pt-5"><div class="row text-left"><div class="col-md-4 col-sm-12"><h5>Navigation</h5><ul><li class=nav-item><a class=smooth-scroll href=/#about>About</a></li><li class=nav-item><a class=smooth-scroll href=/#projects>Achievements</a></li><li class=nav-item><a class=smooth-scroll href=/#recent-posts>Recent Posts</a></li><li class=nav-item><a class=smooth-scroll href=/#experiences>Experiences</a></li></ul></div></div></div><hr><div class=container><div class="row text-left"><div class=col-md-4><a id=theme href=https://github.com/hossainemruz/toha target=_blank rel=noopener><img src=/images/theme-logo_hu8376fd15465fef26ffe66b6bcf0ca686_13669_32x0_resize_box_2.png alt="Toha Theme Logo">
Toha</a></div><div class="col-md-4 text-center">© 2020 Copyright.</div><div class="col-md-4 text-right"><a id=hugo href=https://gohugo.io/ target=_blank rel=noopener>Powered by
<img src=/images/hugo-logo.svg alt="Hugo Logo" height=18></a></div></div></div></footer><script type=text/javascript src=/js/jquery-3.4.1.min.js></script><script type=text/javascript src=/js/popper.min.js></script><script type=text/javascript src=/js/bootstrap.min.js></script><script type=text/javascript src=/js/navbar.js></script><script type=text/javascript src=/js/plyr.js></script><script type=text/javascript src=/js/main.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/highlight.min.js></script><script src=/js/single.js></script><script>hljs.initHighlightingOnLoad();</script></body></html>