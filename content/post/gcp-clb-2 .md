---
title: GCP-Cloud Load Balancer...2
categories:
  - "cloud"
tags:
  - "gcp"
  - "google cloud"
---
GCP CLB를 사용해본 뒤 내용과 시행착오를 풀어봤습니다.

-by Dominic

<!--more-->

## 배경
앞서 1편에서 각기 LB들의 서비스 특징과 workflow에 대해 정리했다면
이번 글은 실제 서비스에서 GCP LB를 사용하며 겪었던 시행착오들을 가장 low한 레벨부터 적어보고자 합니다.

### 1. LB를 사용할 때 백엔드 서비스 구성은 생각보다 난해한 포인트들이 있다.
우선 LB의 백엔드 구성 간 선택지는 기본적으로 백엔드 서비스, 버킷, TCP에는 인스턴스 Pool을 직접 연결하기도 하지만
저의 경우 GCP 내의 VM으로 트래픽을 전달받아야하기 때문에 백엔드 서비스의 인스턴스 그룹 혹은 인스턴스 Pool로 셋팅합니다.

이때 그룹의 종류가 두가지로 나뉘는데 앞서 1편에서 말했던 인스턴스 그룹의 두 종류인 비관리형(Unmanaged Instance Group)과 관리형(Managed Instance Group)  그룹입니다.

1-1 **MIG**는 단일 region 내 멀티 zone에 VM 인스턴스를 분산함으로써 single zone failure 에 대응하여 워크로드의 고가용성을 높일 수 있습니다.

예를 들어, zonal failure 가 발생하거나 특정 zone 내에 위치한 인스턴스들에 장애 발생시, regional MIG 에 포함된 다른 zone에서 실행되는 인스턴스가 트래픽을 처리함으로써 고가용성을 구성할 수 있습니다. 

---
**[MIG 의 특징]**
- 애플리케이션 로드를 멀티 zone 으로 분산


- 최대 2,000개의 인스턴스까지 관리 가능 (zonal MIG의 2배)


- 멀티 zone 을 사용함으로써 zonal failure 및 단일 zone 내 인스턴스 그룹의 오작동과 같은 시나리오로부터 보호


- zonal failure 발생 혹은 zone 내 인스턴스 장애시, regional MIG에 포함된 다른 zone 에서 트래픽을 처리

---

1-2 **UIG**는 단순히 같은 zone내의 인스턴스들을 집합화 시킨 server pool이라고 이해하면 됩니다.

인스턴스 템플릿이 필요하지 않습니다. 단지 같은 zone내의 인스턴스라면 그룹화시켜 LB를 통해 트래픽을 받을 수 있습니다.

UIG를 사용할지 MIG를 사용할지는 어떤 서비스를 제공하는지에 따라 다릅니다.
우리의 인프라로써 UIG가 가장 베스트합니다.

MIG는 동일한 구성의 인스턴스를 여러 개 만들기 위한 것입니다. 기존 인스턴스 템플릿을 업데이트하거나 생성된 인스턴스 템플릿을 변경할 수 없습니다. 구성을 변경해야 하는 경우 새 인스턴스 템플릿을 만듭니다. 

그러나 UIG는 전혀다른 스펙과 구성의 인스턴스들을 그룹핑 시킬 수 있습니다.
따라서 게임서비스의 특성 상 순간적인 트래픽이 발생하기보단 꾸준한 유저들의 동접 수를 대응하기에 예상 트래픽의 최대치를 기준으로 서버를 생성하고 일정기간 모니터링하여 optimizing하는 방법으로 GCP를 활용하고 있습니다. 그러나 항상 single zone failure에 대한 고민을 하고 있습니다. (좋은 방법 있을까요? (°∀°)b)

---
### 2. LB의 헬스체크를 담당하는 GCP managed Global server가 있다?!
HTTP(s) LB는 간편합니다. L7 계층에서 동작하며 
클라이언트가 전달 규칙에 정의된 외부 IPv4 주소로 콘텐츠 요청을 보냅니다.
전달 규칙은 요청을 대상 HTTP 프록시로 전달합니다.
대상 프록시는 URL 맵의 규칙을 사용하여 트래픽을 정확히 송신합니다.