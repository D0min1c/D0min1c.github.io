<!doctype html><html class=no-js lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=theme-color content="#1b1b1b"><title>아니 글쎄 갑자기 인스턴스가 죽었다니까요? - AWS | 255.255.248.0</title><script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script><meta name=description content><meta property="og:title" content="아니 글쎄 갑자기 인스턴스가 죽었다니까요? - AWS"><meta property="og:description" content="마른하늘의 날벼락 같은 인스턴스 Reboot 현상에 대해 원인과 경험을 적어놨습니다."><meta property="og:type" content="article"><meta property="og:url" content="https://21sub.net/post/aws/aws_issue/"><meta itemprop=name content="아니 글쎄 갑자기 인스턴스가 죽었다니까요? - AWS"><meta itemprop=description content="마른하늘의 날벼락 같은 인스턴스 Reboot 현상에 대해 원인과 경험을 적어놨습니다."><meta itemprop=wordCount content="750"><meta itemprop=keywords content="aws,public cloud,"><meta name=twitter:card content="summary"><meta name=twitter:title content="아니 글쎄 갑자기 인스턴스가 죽었다니까요? - AWS"><meta name=twitter:description content="마른하늘의 날벼락 같은 인스턴스 Reboot 현상에 대해 원인과 경험을 적어놨습니다."><link rel=stylesheet href=/css/bundle.css><link rel=stylesheet href=/css/custom.css><link rel=icon href=/icons/16.png sizes=16x16 type=image/png><link rel=icon href=/icons/32.png sizes=32x32 type=image/png><link rel=manifest href=/manifest.json><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-199142344-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script></head><body class="body kind-page"><header class=header><a class=logo href=/>255.255.248.0</a><nav class="main-nav main-nav--right" role=navigation><button id=toggle class=main-nav__btn aria-label="Menu toggle" aria-expanded=false tabindex=0><div class=main-nav__btn-box tabindex=-1><svg class="main-nav__icon icon-menu" width="18" height="18" viewBox="0 0 18 18"><path class="icon-menu__burger" d="M18 0v3.6H0V0h18zM0 10.8h18V7.2H0v3.6zM0 18h18v-3.6H0V18z"/><path class="icon-menu__x" d="M11.55 9 18 15.45 15.45 18 9 11.55 2.55 18 0 15.45 6.45 9 0 2.55 2.55.0 9 6.45 15.45.0 18 2.55 11.55 9z"/></svg></div></button><ul id=menu class=main-nav__list><li class=main-nav__item><a class=main-nav__link href=/about_dominic/><span class=main-nav__text>About Dominic</span></a></li><li class=main-nav__item><a class=main-nav__link href=/post/certificate/aws-saa/><span class=main-nav__text>AWS Certified Solutions Architect – Associate</span></a></li><li class=main-nav__item><a class=main-nav__link href=/awskrug/><span class=main-nav__text>AWSKRUG-Beginner</span></a></li></ul></nav></header><div class=primary><main class=main><nav class="breadcrumb block" aria-label=breadcrumb><ol class=breadcrumb__list><li class=breadcrumb__item><a class=breadcrumbs__link href=/>21sub.net</a></li><li class=breadcrumb__item><a class=breadcrumbs__link href=/post/>Posts</a></li><li class="breadcrumbs__item breadcrumb__item--active" aria-current=page>아니 글쎄 갑자기 인스턴스가 죽었다니까요? - AWS</li></ol></nav><div class="single block"><article class=entry><div class="entry__meta meta mb"><span class="entry__meta-categories meta-categories"><span class=meta-categories__list>Categories:
<a class=meta-categories__link href=/categories/aws/ rel=category>AWS</a></span></span></div><h1 class=entry__title>아니 글쎄 갑자기 인스턴스가 죽었다니까요? - AWS</h1><div class=entry__content><p>마른하늘의 날벼락 같은 인스턴스 Reboot 현상에 대해 원인과 경험을 적어놨습니다.</p><h2 id=배경>배경</h2><p>GCP 혹은 AWS를 사용하면서 종종 Host Error! 혹은 Instance check Failed를 경험한 적이 있으시죠?
우선 AWS를 기준으로 이슈에 대해 정리해보았습니다.</p><h3 id=aws-system-check-failed>AWS System Check failed</h3><p>다들 아시다시피 ec2 인스턴스는 <strong>AWS에서 Iaas 방식으로 제공하는 서비스</strong>이기에 사용자가 해당 ec2 인스턴스를 프로비저닝하게 될 경우 선택한 리전과 가용영역의 데이터 센터 내 host computer에서 hypervisor 위에 고객의 요청에 의해 insatnce를 생성하여 제공하는 방식입니다.</p><p>여기서 만약 hypervisor와 instance간의 Network이 끊긴다면..? 아니면 Host 장비에 불이 난다면&mldr;?</p><p><strong>와장창-!</strong> 말 그대로 인스턴스가 와장창 납니다.</p><p>이러한 갑작스러운 이슈로 인해 발생하는 AWS 하드웨어의 Maintenance Event 혹은 System checkfailed 이슈로 인해 발생하는 예기치않은 이슈에 대해 정리하고 사례에 맞춰 사용자들은 어떻게 대처해야하는지에 경험을 공유하고자 합니다.</p><p>들어가기 앞서 모든 AWS Maintenance 는 일정을 조정하는 것이 가능하다는 점 참고해주시면 되겠습니다.</p><h2 id=aws-maintenance>AWS Maintenance</h2><p>우선 AWS에서의 EC2 Event 종류와 Cloudwatch에서 확인할 수 있는 Status Check failed 지표는 아래와 같은 내용을 포함합니다.</p><ul><li><p>AWS Event</p><ul><li>Instance stop : 예약된 시간에 인스턴스가 중지됩니다. 인스턴스를 다시 시작하면 <strong>새 호스트로 마이그레이션됩니다.</strong></li></ul><p>이러한 유형은 Amazon EBS가 지원하는 인스턴스에만 적용됩니다.</p><ul><li>Instance retirement</li><li>Instance reboot</li><li>System reboot</li><li>System maintenance</li></ul></li></ul><h3 id=instance-stop>Instance stop</h3><p>: 예약된 시간에 인스턴스가 중지됩니다. 인스턴스를 다시 시작하면 <strong>새 호스트로 마이그레이션됩니다.</strong></p><p>Instance stop이 일어나는 경우는 대게 Host hardware의 폐기 날이 결정된 것입니다.</p><p>이 경우, Maintenance 일정 이전에 스스로 stop/start를 진행하여 해소 할 수 있습니다.</p><p>두 눈을 크게 뜨고 정확히 봐야합니다. Instance reboot이 아닌, Stop인 것을요.</p><p>Stop되어있는 인스턴스는 어떤 트리거가 발생하기 전까지는 결코 혼자서 벌떡 일어나진 않습니다.</p><pre><code>이러한 유형은 Amazon EBS가 지원하는 인스턴스에만 적용됩니다.
</code></pre><p>참고로 PHD(persnal Health Dashborad)에서 성능저하로 인해 예약된 이벤트들의 경우 되도록 빨리 인스턴스를 재부팅하여 새 호스트로 마이그레이션하는 것이 좋습니다.</p><p>이미 성능이 저하된 호스트 하드웨어이기에 언제 어떤이슈가 발생할지 모르는 폭탄이기 때문입니다.</p><h3 id=instance-retirement>Instance retirement</h3><p>: 예약된 시간에 인스턴스가 Amazon EBS에서 지원되는 경우 중지되거나 인스턴스 스토어에서 지원되는 경우 종료됩니다.</p><p>말 그대로 EBS 지원 인스턴스는 stop, 인스턴스스토어 지원 인스턴스는 terminate되는 이벤트입니다.</p><p>아직 발생해본적이 없어서 패스하겠습니다. (뭐..다를거 있겠냐만..)</p><h3 id=system-maintenance>System maintenance</h3><p>: 예약된 시간에 네트워크 또는 전력 유지 관리로 인스턴스가 일시적인 영향을 받을 수 있습니다</p><p>네트워크 유지 관리 시에는 예약된 인스턴스의 네트워크 연결이 잠시 동안 끊어집니다. 유지 관리가 완료되면 인스턴스의 네트워크 연결이 평소처럼 복구됩니다.</p><p>전력 유지 관리 시에는 예약된 인스턴스가 잠시 동안 오프라인 상태로 전환되었다가 재부팅됩니다. 재부팅 이후에도 인스턴스의 모든 구성 설정은 그대로 유지됩니다.</p><p>이제 가장 주로 겪은 두가지 이벤트를 다뤄보겠습니다.</p><p>하이라이트 입니다.</p><h3 id=instance-reboot>Instance reboot</h3><p>: 예약된 시간에 인스턴스가 재부팅됩니다.</p><p>말그대로 인스턴스의 재부팅을 의미하기에 os에서 reboot하는것과 동일하게 동작합니다.</p><p>메인터넌스 일정 이내에 사용자가 스스로 reboot을 먼저 실행하여 해소하는 방법과 메인터넌스 일정에 자연스럽게 해소하는 방법이 있습니다. EBS 볼륨의 데이터는 영향을 받지 않습니다.</p><p>유의사항으로는 인스턴스 재부팅 시 인스턴스스토어 볼륨 데이터와 public IP가 변경되기에 Elastic IP를 할당하여 고정 IP를 사용하고</p><p>만약 인스턴스스토어 볼륨을 사용한다면 미리 데이터를 백업해놓아야 합니다.</p><h3 id=system-reboot>System reboot</h3><p>: 예약된 시간에 인스턴스의 호스트가 재부팅됩니다.</p><p>인스턴스의 재부팅이 아닌, 인스턴스가 올라가있는 호스트 하드웨어의 재부팅입니다.</p><p>일반적인 사용자가 스스로 이벤트를 해소할 수 있는 방법이 없습니다.</p><p><del>(일반적이지 못한 경우 : 인스턴스 위치를 어떻게든 찾아서 업체점검으로 속이고 치..침투하여 리붓)</del></p><p>농담이고, AMI를 생성해서 다시 만들면 메인터넌스를 회피할 수 있습니다. (Instance reboot과 동일하게 Elastic IP 유지필요, 인스턴스스토어 볼륨 데이터 증발)</p><p>필요에 의하지 않다면 AWS에 온전히 작업을 맡기는 것이 좋을 것 같습니다.</p><p>다행히도 AWS가 시스템을 재부팅해도 DNS 이름이나 IP 주소와 같은 구성이 변경되지 않으며, 로컬 인스턴스 스토어에 저장된 데이터도 그대로 보존됩니다.</p><p>통상 이러한 재부팅들은 수 분 내에 끝난다고 말하지만 대부분의 경우 3분안에 이벤트가 종료되었던 것으로 경험했습니다.</p><p>모든 경우에서 서비스 서버(EC2)들은 AMI나 Snapshot을 통해 백업해두는 것이 가장 현명합니다.</p><p>이제 메인 빌런인 <strong>갑작스러운 하드웨어 이슈에 의한 EC2 Reboot</strong> 입니다.</p><p>보통 잘자다가 새벽에 천둥같은 알람이 울면 인스턴스의 모니터링 지표에 (System, Instance) Status check failed 알람이 발생하는 경우도 있습니다.</p><p>이게 무엇인고하니, AWS는 두 가지 상태 확인을 통해 각 EC2 인스턴스 상태를 내부 모니터링 툴을 사용하여 모니터링합니다.</p><p>자세한 내용은 AWS Docs에 잘나와있으니 축약하여 메모해놓겠습니다.</p><ul><li>요약<ul><li>시스템 상태 확인 실패는 인스턴스가 실행되는 AWS 시스템에 문제가 있음을 나타냅니다. (하드웨어 이슈)</li><li>인스턴스 상태 확인 실패는 대게 OOM(OutOfMemory) 등 리소스 이슈 혹은 잘못된 OS config 수정에 의해 발생합니다. (OS 이슈) ~~(간혹 커널)</li></ul></li></ul><p>그렇기에 만약 인스턴스가 죽어서 Cloudwatch의 메트릭에서 위와같은 상태 검사 메트릭을 우선 확인한 뒤,</p><p>CPU, memory (Custom Metric으로 받아와야합니다.), Volume IO 등 리소스 사용량과 콘솔 상에서 확인할 수 있는 시스템 로그를 통해 dmsg 로그 확인 및 본인이 마지막으로 서버에 무슨 작업을 했는지 확인해야하고</p><p>시스템 상태검사 실패라면 재빠르게 stop/start 혹은 해당 이벤트를 트리거로 걸어두어 자동 reboot 작업을 걸어두는 것이 좋습니다.</p><p><a href=https://docs.aws.amazon.com/ko_kr/AWSEC2/latest/WindowsGuide/monitoring-instances-status-check.html>AWS 인스턴스 상태 모니터링 링크</a></p><p>여러분 세상에 100% 안죽는 서버는 없습니다. <del>(사장님 저는 안죽습니다)</del></p><p>그러니 너무 스트레스 받아하지 마세요. 어쩔 수 없는걸요.</p><p>그렇기에 항시 대비하고 있어야 합니다. 소 잃고 외양간 고치는 것보다 소가 도망쳐도 다시 잡을 수 있게 위치 추적기를 심는게 중요합니다.</p><p>서버 한 두대가 죽어도 서비스는 유지될 수 있도록 고가용성 구조를 구성하시는게 가장 좋지만 여러 어른들의 사정에 의해 불가능하다면 최소한 모니터링을 걸어두어 서비스의 빠른 Recovery가 중요합니다.</p><p>감사합니다.</p></div><footer class=entry__footer><div class=entry__tags><a class="entry__tag btn" href=/tags/aws/>aws</a>
<a class="entry__tag btn" href=/tags/public-cloud/>public cloud</a></div></footer></article></div></main><div class="authorbox block"><div class=author><figure class=author__avatar><img class=author__img alt="Dominic avatar" src=/img/avatar.png height=90 width=90></figure><div class=author__body><div class=author__name>Dominic</div><div class=author__bio>Dominic's true identity is unknown. Maybe he is a cute fairy or slave :D</div></div></div></div><div class="related block"><h3 class=related__title>Related</h3><ul class=related__list><li class=related__item><a class=related__link href=/post/certificate/aws-saa/>AWS Certified Solutions Architect – Associate</a></li><li class=related__item><a class=related__link href=/post/gcp/gcp_clb_1/>GCP-Cloud Load Balancer(1) 내용정리</a></li><li class=related__item><a class=related__link href=/post/gcp/gcp_clb_2/>GCP-Cloud Load Balancer(2) 테스트</a></li><li class=related__item><a class=related__link href=/post/gcp/gcp_vpc/>Network 기초(VPC) - GCP</a></li><li class=related__item><a class=related__link href=/post/gcp/gcp_issue/>아니 글쎄 갑자기 인스턴스가 죽었다니까요? - GCP</a></li></ul></div><section class="comments block"><div id=disqus_thread></div><script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return;}
var d=document,s=d.createElement('script');s.async=true;s.src='//'+"dominic"+'.disqus.com/embed.js';s.setAttribute('data-timestamp',+new Date());(d.head||d.body).appendChild(s);})();</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></section></div><footer class=footer><div class="footer__social social"><a class=social__link target=_blank rel="noopener noreferrer" href=https://www.instagram.com/seob.199b><svg class="social__icon" aria-label="Instagram" role="img" width="32" height="32" viewBox="0 0 512 512"><g fill="none" stroke-width="29"><rect height="296" rx="78" width="296" x="108" y="108"/><circle cx="256" cy="256" r="69"/></g><circle cx="343" cy="169" r="19"/></svg></a><a class=social__link target=_blank rel="noopener noreferrer" href=https://linkedin.com/in/hanseob-lee-9655781aa><svg class="social__icon" aria-label="LinkedIn" role="img" width="32" height="32" viewBox="0 0 512 512"><circle cx="142" cy="138" r="37"/><path stroke-width="66" d="M244 194v198M142 194v198"/><path d="M276 282c0-20 13-40 36-40 24 0 33 18 33 45v105h66V279c0-61-32-89-76-89-34 0-51 19-59 32"/></svg></a><a class=social__link target=_blank rel="noopener noreferrer" href=https://github.com/D0min1c><svg class="social__icon" aria-label="Github" role="img" width="32" height="32" viewBox="0 0 512 512"><path d="M335 499c14 0 12 17 12 17H165s-2-17 12-17c13 0 16-6 16-12l-1-50c-71 16-86-28-86-28-12-30-28-37-28-37-24-16 1-16 1-16 26 2 40 26 40 26 22 39 59 28 74 22 2-17 9-28 16-35-57-6-116-28-116-126 0-28 10-51 26-69-3-6-11-32 3-67 0 0 21-7 70 26 42-12 86-12 128 0 49-33 70-26 70-26 14 35 6 61 3 67 16 18 26 41 26 69 0 98-60 120-117 126 10 8 18 24 18 48l-1 70c0 6 3 12 16 12z"/></svg></a></div><div class=footer__copyright>© 2021 Binario. <span class=footer__copyright-credits>Powered by <a href=https://gohugo.io/ rel="nofollow noopener" target=_blank>Hugo</a> and <a href=https://github.com/vimux/binario rel="nofollow noopener" target=_blank>Binario</a> theme.</span></div></footer><script src=/js/menu.js></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.6/MathJax.js?config=TeX-AMS-MML_HTMLorMML" async></script><script src=/js/custom.js></script></body></html>