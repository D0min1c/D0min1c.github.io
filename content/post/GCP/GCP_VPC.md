---
title: Network 기초(VPC) - GCP
categories:
  - "GCP"
tags:
  - "gcp"
  - "public cloud"
---
GCP VPC를 처음 겪어보는 당신에게 추천합니다.

<!--more-->

## 배경
GCP를 통해 클라우드를 입문하셨거나, AWS를 사용하다가 GCP로 넘어오신 분들, 갑작스런 변화에 살짝 오잉? 하셨을겁니다.

저는 저만의 오잉 포인트들을 모아서 기록해두었습니다. 고고

##  GCP의 VPC (Virtual private cloud)

GCP의 VPC에 대해 우선 짚어봅시다.

VPC (Virtual private cloud)란, 간단하게 클라우드 환경 상의 논리적으로 격리된 개개인의 사설 네트워크 망을 말합니다.

보통 AWS의 인프라 환경은 굉장히 계층적인 구조를 보여줍니다.

가령, 리전(국가) 내에 여러 가용영역(도시)들이 있으며 가용영역들은 1개이상의 개별 데이터센터로 구축되어있습니다. 

또한 가용영역 간 동기복제를 수행하기 떄문에 사용자는 여러 리전, 가용영역들에 애플리케이션을 배포함으로써 고가용성의 이점을 얻을 수 있습니다.

들어가기 앞서 기본적으로 AWS GCP의 공통사항을 먼저 다루자면

서브넷에 이미 AWS(GCP)에서 예약해놓은 IP 주소들이 있다는 점

x.x.x.0 , x.x.x.1, x.x.x.254, x.x.x.255

-------

## 구조적 차이를 이해하자!

![This is an image](/img/ aws_vpc.jpg)

AWS는 말그대로 계층적인 구조를 가지고 있습니다.

- **Virtual Private Cloud(VPC)** — 사용자의 AWS 계정 전용 가상 네트워크입니다.
- **서브넷** — VPC의 IP 주소 범위입니다.
- **라우팅 테이블** — 네트워크 트래픽을 전달할 위치를 결정하는 데 사용하는 라우팅이라는 이름의 규칙 집합입니다.
- **인터넷 게이트웨이** — VPC의 리소스와 인터넷 간의 통신을 활성화하기 위해 VPC에 연결하는 게이트웨이입니다.

VPC는 리전에 연결되어 Cidr값을 지정하고 Cidr값을 subnetting하여 각 가용영역에 지정합니다.(인스턴스를 생성해야하니까요!?)



근데 GCP는 그렇지 않습니다. 애초부터 VPC가 리전에 종속되지 않습니다. 



![This is an image](/img/gcp_vpc.jpg)



GCP의 VCP는 특정 가용영역과 리전에 종속되지 않는 전역 리소스입니다. GCP에서의 전역리소스는 동일 프로젝트 내의 모든 영역에 있는 모든 리소스가 엑세스 할 수 있다는 뜻입니다.

- **Virtual Private Cloud(VPC)** — 사용자의 GCP 계정 전용 가상 네트워크입니다.
- **서브넷** — ~~VPC의 IP 주소 범위입니다.~~ 아닙니다. 각 가용영역 (GCP에선 zone)의 대역입니다. 
- **라우팅 테이블** — 네트워크 트래픽을 전달할 위치를 결정하는 데 사용하는 라우팅이라는 이름의 규칙 집합입니다.
- **인터넷 게이트웨이** — VPC의 리소스와 인터넷 간의 통신을 활성화하기 위해 VPC에 연결하는 게이트웨이입니다.



AWS에서 도쿄리전과 서울리전의 각각의 인스턴스를 두고 있고 서로 통신이 필요할 경우, 별도의 분리된 VPC 간의 통신을 지원할 무언가가 필요한 상황입니다.

그러나, GCP의 서브넷이 리전에 연결되기에 단지 내부 라우팅을 열어줌으로써 도쿄 리전의 인스턴스와 서울리전의 인스턴스가 통신이 가능하게 된다는 말입니다.

VPC는 리전에 종속되지 않습니다. VPC 내 서브넷들이 각 리전에 연결되어 Cidr값을 지정하고 Routing Table, Firewall rule에 따라 트래픽의 흐름을 보여줍니다.



## 차이를 하나만 더보자면 아마 피어링 ? (VPC Peering)

각 벤더에서 VPC 간 트래픽을 라우팅 하고자할때 위와같은 특성에 의해 고려해야될 부분들이 갈린다.

### AWS는 동일 리전의 VPC 간 peering, 계정 간 VPC peering, 리전간 VPC peering으로 나뉜다.

이때 3가지 방법 모두 라우팅 테이블에 peering connect를 만들어 서로 본인의 사설 Cidr 값을 라우팅으로 추가해주어야 합니다.



### GCP는 서로다른 Organization, project 간 VPC  피어링만 고민하면된다.

리전 간 통신은 위 설명대로 방화벽으로 제어하며, 방화벽 상에서 서로의 서브넷을 ingress, Egress로 추가한 네트워크 태그를 인스턴스에 추가하여 허용할 수 있기 때문에 서로 다른 Org 간 혹은 Project 간의 Priavte 통신이 필요한 경우에만 고려하면 됩니다. 



## VPC peering을 고려한다면 AWS든 GCP든 subnet을 겹치게 생성하지 말자.

중요합니다. 만약 AWS든 GCP든 VPC를 분리하여 사용하고자 할 때 (가령 중앙화나 로그수집에 대한 인프라 구축, VPN 등) 서브넷의 대역이 겹쳐 피어링을 맺지 못한다면 Public IP 간 통신을 해야합니다. 트래픽이 Global 망을 타고 나갔다 들어오기 떄문에 보안적으로도 비용적으로도 성능적으로도 좋지 못한 구성이기 때문입니다.  ~~(어쩔수 없으면 쓸 수 밖에 없겠네요 저같이..)~~

대역이 겹치는 이슈 이외에도 몇가지 제한되는 사항들이 있는데, 이는 각 벤더 문서에서 VPC peering을 검색해보면 됩니다.

아래는 공통적으로 제한되는 부분에 대해서만 서술해두었습니다.

### 제한사항

- 피어링된 한 VPC 네트워크의 서브넷 CIDR 범위는 다른 피어링된 네트워크의 대역과 겹칠 수 없습니다.
  - 제.곧.내 (제목이 곧 내용)

- 직접 피어링된 VPC끼리만 통신이 가능합니다.

  - 가령 A, B, C VPC가 있다고 가정하였을때, A <-> B 사이에 peering을 구성해놓고, 이후 B<->C의 피어링을 맺으면 중간의 B VPC가 마치 Hub의 역할을 하여 A<->C도 connection이 이뤄진다고 생각할 수 있습니다.

    결론부터 말하자면 불가능합니다.

    VPC peering의 connection은 각각 독립적인 Connection이기에 위와같은 구조를 원한다면 AWS Trangit Gateway를 통하거나,
    처음부터 B<->C의 peering을 설정하면 되는 문제입니다.

- 제한사항은 아니지만 보통 피어링이 성공적으로 Connection됬는데 서버 간 통신이 안되면 당연히 라우팅 확인과 서버의 보안그룹(방화벽)등을 확인해야합니다. 



GCP VPC와 나아가 Network Peering에 대해 간단하게 풀어봤습니다.

감사합니다.

